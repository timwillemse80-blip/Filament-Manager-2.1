
# Filament Manager

Beheer je 3D-printer filamentvoorraad eenvoudig en modern.

## ðŸš€ Deployen naar Vercel (Stappenplan)

Omdat je al een Vercel account hebt, is het online zetten heel simpel.

### Stap 1: GitHub
1.  Zorg dat je deze code downloadt of in een mapje op je computer hebt.
2.  Maak een nieuwe repository aan op [GitHub.com](https://github.com/new).
3.  Upload al deze bestanden naar die repository.

### Stap 2: Vercel Project
1.  Log in op je [Vercel Dashboard](https://vercel.com/dashboard).
2.  Klik op **Add New...** > **Project**.
3.  Kies **Continue with GitHub** en selecteer de repository die je net hebt gemaakt.
4.  Geef het project een naam (bijv. `filament-manager`).

### Stap 3: Environment Variables (BELANGRIJK!)
Voordat je op "Deploy" klikt, moet je Ã©Ã©n variabele instellen zodat de AI scanner werkt:

1.  Klap het kopje **Environment Variables** open.
2.  Vul in bij Key: `API_KEY`
3.  Vul in bij Value: *[Jouw Google Gemini API Key]*
4.  Klik op **Add**.

*(Optioneel: Als je je eigen Supabase database wilt gebruiken in plaats van de ingebouwde test-database, voeg dan ook `VITE_SUPABASE_URL` en `VITE_SUPABASE_ANON_KEY` toe).*

### Stap 4: Live!
Klik op **Deploy**. Vercel bouwt nu je app. Binnen 1-2 minuten is je app live!

---

## ðŸ› ï¸ Database Updates (SQL)

Als je de app update, moet je soms nieuwe tabellen aanmaken in Supabase.

### Update 1.6: Account Verwijderen (Update & Fix)
**BELANGRIJK:** Voer dit script uit om de functie voor account verwijdering correct in te stellen en de database helemaal up-to-date te brengen. Dit script repareert ook "policy already exists" fouten, lost het probleem op met de `user_settings` foreign key EN staat gebruikers toe hun eigen verzoek te annuleren.

```sql
-- ================================================================
-- 1. TABELLEN VOOR FEEDBACK & ACCOUNT VERWIJDEREN
-- ================================================================

-- Feedback tabel
create table if not exists public.feedback (
  id bigint generated by default as identity primary key,
  created_at timestamptz default now(),
  message text not null,
  rating smallint default 0,
  user_id uuid default auth.uid() references auth.users(id) on delete cascade,
  platform text,
  user_agent text
);
alter table public.feedback enable row level security;

-- Oude policies wissen (voorkomt "already exists" errors)
drop policy if exists "Iedereen mag feedback sturen" on public.feedback;
drop policy if exists "Admins mogen lezen" on public.feedback;
drop policy if exists "Admins mogen verwijderen" on public.feedback;

create policy "Iedereen mag feedback sturen" on public.feedback for insert with check (true);
create policy "Admins mogen lezen" on public.feedback for select using (true);
create policy "Admins mogen verwijderen" on public.feedback for delete using (true);

-- Verwijder verzoeken tabel
create table if not exists public.deletion_requests (
  id uuid default gen_random_uuid() primary key,
  user_id uuid default auth.uid() references auth.users(id) on delete cascade,
  email text,
  reason text,
  created_at timestamptz default now()
);
alter table public.deletion_requests enable row level security;

-- Reset policies voor requests
drop policy if exists "Eigen verzoek indienen" on public.deletion_requests;
drop policy if exists "Admins mogen lezen" on public.deletion_requests;
drop policy if exists "Admins mogen verwijderen" on public.deletion_requests;
drop policy if exists "Eigen verzoek bekijken" on public.deletion_requests;
drop policy if exists "Eigen verzoek annuleren" on public.deletion_requests;

create policy "Eigen verzoek indienen" on public.deletion_requests for insert with check (auth.uid() = user_id);
create policy "Admins mogen lezen" on public.deletion_requests for select using (true);
create policy "Admins mogen verwijderen" on public.deletion_requests for delete using (true);
-- Nieuw: Gebruikers mogen hun eigen verzoek zien en intrekken
create policy "Eigen verzoek bekijken" on public.deletion_requests for select using (auth.uid() = user_id);
create policy "Eigen verzoek annuleren" on public.deletion_requests for delete using (auth.uid() = user_id);


-- ================================================================
-- 2. UPDATE PRINTERS TABEL (PRO FEATURES)
-- ================================================================

create table if not exists public.printers (
  "id" uuid primary key,
  "user_id" uuid not null references auth.users(id) on delete cascade,
  "name" text,
  "brand" text,
  "model" text,
  "hasAMS" boolean,
  "amsCount" smallint,
  "amsSlots" jsonb
);
alter table public.printers enable row level security;

drop policy if exists "Gebruikers beheren eigen printers" on public.printers;
create policy "Gebruikers beheren eigen printers" on public.printers for all using (auth.uid() = user_id);

-- Voeg nieuwe kolommen toe als ze nog niet bestaan (voor de calculator)
alter table public.printers add column if not exists "powerWatts" numeric;
alter table public.printers add column if not exists "purchasePrice" numeric;
alter table public.printers add column if not exists "lifespanHours" numeric;


-- ================================================================
-- 3. SPOEL GEWICHTEN & PRINT LOGBOEK
-- ================================================================

-- Lege spoelen database
create table if not exists public.spool_weights (
  id bigint generated by default as identity primary key,
  name text not null,
  weight numeric not null
);
alter table public.spool_weights enable row level security;

drop policy if exists "Iedereen mag lezen" on public.spool_weights;
drop policy if exists "Ingelogden mogen toevoegen" on public.spool_weights;
drop policy if exists "Ingelogden mogen wijzigen" on public.spool_weights;
drop policy if exists "Ingelogden mogen verwijderen" on public.spool_weights;

create policy "Iedereen mag lezen" on public.spool_weights for select using (true);
create policy "Ingelogden mogen toevoegen" on public.spool_weights for insert with check (auth.role() = 'authenticated');
create policy "Ingelogden mogen wijzigen" on public.spool_weights for update using (auth.role() = 'authenticated');
create policy "Ingelogden mogen verwijderen" on public.spool_weights for delete using (auth.role() = 'authenticated');

-- Print Logboek
create table if not exists public.print_jobs (
  "id" uuid primary key,
  "user_id" uuid not null references auth.users(id) on delete cascade,
  "name" text,
  "date" text,
  "printTime" text,
  "totalWeight" numeric,
  "calculatedCost" numeric,
  "status" text,
  "usedFilaments" jsonb,
  "printerId" text
);
alter table public.print_jobs enable row level security;

drop policy if exists "Gebruikers beheren eigen prints" on public.print_jobs;
create policy "Gebruikers beheren eigen prints" on public.print_jobs for all using (auth.uid() = user_id);


-- ================================================================
-- 4. FUNCTIE: ACCOUNT VOLLEDIG VERWIJDEREN (SUPER ADMIN)
-- ================================================================

-- Eerst oude functie verwijderen om conflicten te voorkomen
drop function if exists delete_user_completely(uuid);

create or replace function delete_user_completely(target_user_id uuid)
returns void
language plpgsql
security definer
set search_path = public, auth, storage 
as $$
begin
  -- 1. Probeer opslag te wissen (vangen fout op als storage niet actief is)
  begin
    delete from storage.objects where owner = target_user_id;
  exception when others then
    null; -- Ga door als opslag leeg/niet bestaat
  end;

  -- 2. Verwijder alle app data expliciet
  delete from public.filaments where user_id = target_user_id;
  delete from public.print_jobs where user_id = target_user_id;
  delete from public.printers where user_id = target_user_id;
  delete from public.locations where user_id = target_user_id;
  delete from public.suppliers where user_id = target_user_id;
  delete from public.feedback where user_id = target_user_id;
  delete from public.deletion_requests where user_id = target_user_id;
  
  -- 2b. Probeer user_settings te verwijderen (lost foreign key error op)
  -- We gebruiken een exception block voor het geval de tabel niet bestaat
  begin
    delete from public.user_settings where user_id = target_user_id;
  exception when others then
    null; 
  end;

  -- 3. Verwijder de gebruiker uit Authentication (De klapper)
  delete from auth.users where id = target_user_id;
end;
$$;

-- Geef toegang tot deze functie
grant execute on function delete_user_completely to authenticated;
grant execute on function delete_user_completely to anon;

-- Ververs de API cache
NOTIFY pgrst, 'reload schema';
```

---

## ðŸ”— Je Domeinnaam Koppelen (Strato)
Als je app live staat op Vercel (bijv. `filament-manager.vercel.app`):

1.  Ga in Vercel naar **Settings** > **Domains**.
2.  Voeg je Strato domeinnaam toe (bijv. `mijnfilament.nl`).
3.  Vercel geeft je DNS gegevens (meestal een A-Record IP en een CNAME).
4.  Log in bij Strato, ga naar **Domeinbeheer** > **DNS** en vul die gegevens in.
5.  Wacht tot de vinkjes in Vercel groen worden.

Veel plezier met je app!
